# Species Distribution Model Fitting and Projecting

**About:**

This stage of the workflow is where we fit the seasonal VAST model to the tidy model dataframe. After fitting the model, we then make statistical inferences and use the fitted model to project species distribution and abundance changes under future environmental conditions expected from the CMIP6 global climate models. The code for this stage is found within the [TargetsSDM GitHub repository](https://github.com/aallyn/TargetsSDM) and the [vast_functions.R](https://github.com/aallyn/TargetsSDM/blob/main/R/vast_functions.R) script. Importantly, to leverage these functions, people will want to have defined a few core objects, including: a habitat formula governing the species environmental covariates relationship, the field configuration settings to determine whether spatial or spatio-temporal variability will be turned on, and the rho configuration setting that define if there is an autoregressive structure on the intercepts or the spatio-temporal variability component. 


## Steps

This is one of the more complicated stages of the workflow and has a variety of different steps. This complexity arises for two reasons. First, there are the complexities related to integrating data from two surveys and fitting a seasonal VAST model that includes habitat covariates, catchability covariates, persistent spatial variability, ephemeral spatio-temporal variability, and potential temporal correlations in species occurrence across the study domain in successive seasons. Second, we tried to break down the entire modeling cycle into incremental steps. 

1. VAST objects. There are a variety of objects that we create which define how the VAST model is constructed.

  1a. Make VAST extrapolation grid. 
  
  1b. Make VAST settings
  
  1c. Make VAST spatial lists
  
  1d. Make VAST covariate effect list
  

2. VAST dataframes. Before fitting the seasonal VAST model, we generate a few dataframes that are then passed to the main VAST model fitting function. 

  2a. Make VAST seasonal dataframe. The standard behavior of a single species VAST species distribution model assumes that we have observations that occur annually. In turn, before fitting the VAST seasonal model, we need to do some reformatting. Specifically, we need to create a new vector that we can use as the "year" vector, but, that actually represents the season-year increments. We also want to make sure that there is a dummy observation for every season-year of interest, even those where we may not have survey data. To accomplish both of these goals, we use the `vast_make_seasonal_data` function. We also encourage interested people to look at the [Wiki example in the VAST GitHub repository](https://github.com/James-Thorson-NOAA/VAST/wiki/Seasonal-model) for additional details. 
  
  2b. Make VAST sample dataframe. After creating the VAST seasonal dataframe, we then subset it into three different dataframes. The first is a sample dataframe, which includes the biological catch data information. This is accomplished using the `make_vast_sample_data` function.
  
  2c. Make VAST covariate dataframe. This is the second dataframe we create from the VAST seasonal dataframe, and includes the information for habitat covariates at each of the tow locations. We make this dataframe using the `make_vast_covariate_data` function.
  
  2d. Make VAST catchability dataframe. The final dataframe we create is a catchability dataframe, this includes information for the survey that each observation was collected. 

3. Fitting the VAST seasonal model

  3a. Fitting VAST base model
  
  3b. Making adjustments to accommodate the seasonal model
  
  3c. Fitting VAST seasonal model

4. Making inferences from the fitted VAST seasonal model

  4a. Visualizing covariate effects
  
  4b. Making projections 
  
## Products

## Next stages


